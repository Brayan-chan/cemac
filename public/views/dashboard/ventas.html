<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEMAC - Ventas</title>
    <link rel="stylesheet" href="/css/customsidebar.css">
    <link rel="stylesheet" href="/css/inicio.css">
    <link rel="stylesheet" href="/css/paymentMethods.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" sizes="32x32" href="https://res.cloudinary.com/dmyejrbs7/image/upload/v1757894655/CEMAC-LOGO_nrow82.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/js/tailwind.config.js"></script>
    <script src="/js/utils/sidebarPreloader.js"></script>
    <style>
      #customerPanel {
        transition: all 0.3s ease-in-out;
        opacity: 0;
        transform: translateY(-10px);
        pointer-events: none;
      }
      #customerPanel.visible {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
      }
    </style>
</head>
<body class="h-full bg-gray-50">
    <div id="sidebar" class="fixed left-0 top-0 bg-[#8B7EC7] sidebar-expanded sidebar-transition z-40 sidebar-flex"></div>

    <div id="mainContent" class="main-expanded sidebar-transition">
        <header class="bg-white h-16">
            <div class="flex items-center justify-between h-full px-6">
                <div class="flex-1 flex justify-center">
                    <div class="relative w-full max-w-md mx-4">
                        <input type="text" 
                               placeholder="Search" 
                               class="w-full bg-gray-100 border-0 rounded-full px-4 py-2 pl-10 text-sm focus:outline-none focus:ring-2 focus:ring-[#8B7EC7]">
                        <button class="absolute left-3 top-1/2 transform -translate-y-1/2">
                            <i class="fas fa-search text-gray-400"></i>
                        </button>
                        <button class="absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 bg-gray-200 rounded-full flex items-center justify-center">
                            <i class="fas fa-times text-xs text-gray-500"></i>
                        </button>
                    </div>
                </div>
                <div class="w-64 flex items-center justify-end space-x-2">
                    <button class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                        <i class="far fa-envelope text-gray-600 text-xl"></i>
                    </button>
                    <button class="p-2 hover:bg-gray-100 rounded-lg transition-colors relative">
                        <i class="far fa-bell text-gray-600 text-xl"></i>
                        <span class="absolute top-1 right-1 w-4 h-4 bg-red-500 rounded-full text-xs text-white flex items-center justify-center">3</span>
                    </button>
                    <div class="w-px h-6 bg-gray-300 mx-2"></div>
                    <div id="userMenuContainer"></div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="p-6 flex gap-6">
            <!-- Historial de Ventas Panel -->
            <div class="w-72">
                <div class="bg-gray-200 rounded-lg p-4 h-full">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-[#8B7EC7] to-[#7A6DB4] rounded-lg flex items-center justify-center">
                                <i class="fas fa-clock text-white text-lg leading-none"></i>
                            </div>
                            <h2 class="text-lg font-semibold text-gray-700">Historial</h2>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input id="salesSearchInput" placeholder="Buscar cliente..." class="pl-10 bg-gray-50 border border-gray-200 w-full rounded-lg px-3 py-2 text-sm" />
                        </div>
                    </div>

                    <div class="mb-3" id="salesFilters">
                        <div class="flex gap-2">
                            <button data-filter="todos" class="px-3 py-1 rounded-lg text-sm font-medium bg-[#8B7EC7] text-white">Todos</button>
                            <button data-filter="hoy" class="px-3 py-1 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200">Hoy</button>
                            <button data-filter="semana" class="px-3 py-1 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200">Semana</button>
                            <button data-filter="mes" class="px-3 py-1 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200">Mes</button>
                        </div>
                    </div>

                    <div id="salesStats" class="mb-3">
                        <div class="grid grid-cols-2 gap-3 bg-gradient-to-r from-[#F3EFFA] to-blue-50 p-3 rounded-xl">
                            <div>
                                <p class="text-xs text-gray-600 font-medium">Total Ventas</p>
                                <p id="totalSalesValue" class="text-lg font-bold text-[#8B7EC7]">$0.00</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600 font-medium">Transacciones</p>
                                <p id="transactionsValue" class="text-lg font-bold text-[#8B7EC7]">0</p>
                            </div>
                        </div>
                    </div>

                    <div id="salesList" class="space-y-3 overflow-y-auto max-h-[60vh]"></div>
                </div>
            </div>

            <!-- Formulario de Venta -->
            <div class="flex-1 bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold">Ventas</h1>
                    <button class="flex items-center gap-2 text-white bg-[#8B7EC7] px-4 py-2 rounded-lg hover:bg-[#7A6DB4] transition-colors">
                        <i class="fas fa-download"></i>
                        <span>Exportar</span>
                    </button>
                </div>

                <!-- Agregado: Cliente y Vendedor con panel de cliente frecuente -->
                <div class="grid grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cliente</label>
                        <input type="text" placeholder="Nombre del cliente..." class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-[#8B7EC7] focus:border-[#8B7EC7] focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Vendedor</label>
                        <select class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-[#8B7EC7] focus:border-[#8B7EC7] focus:outline-none">
                            <option value="">No asignado</option>
                        </select>
                    </div>
                </div>

                <!-- B煤squeda de Producto y Configuraci贸n de Descuentos/IVA -->
                <div class="grid grid-cols-2 gap-6 mb-6">
                    <div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-barcode text-gray-400"></i>
                            <label class="block text-sm font-medium text-gray-700">Buscar producto</label>
                        </div>
                        <input type="text" placeholder="Buscar producto..." class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-[#8B7EC7] focus:border-[#8B7EC7] focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Configuraci贸n de Venta</label>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Descuento %</label>
                                <div class="flex">
                                    <input 
                                        id="discountInput" 
                                        type="number" 
                                        min="0" 
                                        max="100" 
                                        step="0.1" 
                                        placeholder="0"
                                        class="w-full border border-gray-300 rounded-l-lg px-3 py-2 text-sm focus:ring-[#8B7EC7] focus:border-[#8B7EC7] focus:outline-none"
                                    >
                                    <span class="bg-gray-100 border border-l-0 border-gray-300 rounded-r-lg px-3 py-2 text-gray-600 text-sm">%</span>
                                </div>
                                <div class="flex gap-1 mt-1">
                                    <button class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded discount-preset" data-discount="5">5%</button>
                                    <button class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded discount-preset" data-discount="10">10%</button>
                                    <button class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded discount-preset" data-discount="15">15%</button>
                                    <button class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded discount-preset" data-discount="20">20%</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">IVA %</label>
                                <div class="flex">
                                    <input 
                                        id="taxInput" 
                                        type="number" 
                                        min="0" 
                                        max="100" 
                                        step="0.1" 
                                        placeholder="0"
                                        class="w-full border border-gray-300 rounded-l-lg px-3 py-2 text-sm focus:ring-[#8B7EC7] focus:border-[#8B7EC7] focus:outline-none"
                                    >
                                    <span class="bg-gray-100 border border-l-0 border-gray-300 rounded-r-lg px-3 py-2 text-gray-600 text-sm">%</span>
                                </div>
                                <div class="flex gap-1 mt-1">
                                    <button class="text-xs bg-blue-100 hover:bg-blue-200 px-2 py-1 rounded tax-preset" data-tax="0">0%</button>
                                    <button class="text-xs bg-blue-100 hover:bg-blue-200 px-2 py-1 rounded tax-preset" data-tax="16">16%</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabla de Productos -->
                <div class="mb-6">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="grid grid-cols-3 gap-4 font-medium text-gray-700 mb-4">
                            <div>Producto</div>
                            <div class="text-center">Cantidad</div>
                            <div class="text-right">Precio</div>
                        </div>
                        <div class="grid grid-cols-3 gap-4 items-center border-b border-gray-200 py-2">
                            <div>Nombre del producto</div>
                            <div class="text-center">1</div>
                            <div class="text-right">$ 0.00</div>
                        </div>
                    </div>
                </div>

                <!-- M茅todo de Pago y Notas -->
                <div class="mb-6">
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">M茅todo de Pago</label>
                            <div class="grid grid-cols-3 gap-2">
                                <button 
                                    class="payment-method-btn bg-green-100 hover:bg-green-200 border-2 border-green-300 text-green-800 px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-1 active"
                                    data-method="efectivo"
                                >
                                    <i class="fas fa-money-bill-wave text-xs"></i>
                                    <span>Efectivo</span>
                                </button>
                                <button 
                                    class="payment-method-btn bg-blue-100 hover:bg-blue-200 border-2 border-transparent text-blue-800 px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-1"
                                    data-method="tarjeta"
                                >
                                    <i class="fas fa-credit-card text-xs"></i>
                                    <span>Tarjeta</span>
                                </button>
                                <button 
                                    class="payment-method-btn bg-purple-100 hover:bg-purple-200 border-2 border-transparent text-purple-800 px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-1"
                                    data-method="transferencia"
                                >
                                    <i class="fas fa-exchange-alt text-xs"></i>
                                    <span>Transfer</span>
                                </button>
                                <button 
                                    class="payment-method-btn bg-orange-100 hover:bg-orange-200 border-2 border-transparent text-orange-800 px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-1"
                                    data-method="cheque"
                                >
                                    <i class="fas fa-file-invoice text-xs"></i>
                                    <span>Cheque</span>
                                </button>
                                <button 
                                    class="payment-method-btn bg-indigo-100 hover:bg-indigo-200 border-2 border-transparent text-indigo-800 px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-1"
                                    data-method="digital"
                                >
                                    <i class="fas fa-mobile-alt text-xs"></i>
                                    <span>Digital</span>
                                </button>
                            </div>
                            <div class="mt-2 text-xs text-gray-500 flex items-center gap-1">
                                <i class="fas fa-info-circle"></i>
                                <span>M茅todo seleccionado: <span id="selectedPaymentMethod" class="font-medium text-gray-700">Efectivo</span></span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Notas (Opcional)</label>
                            <textarea 
                                id="saleNotes" 
                                placeholder="Agregar notas sobre la venta..."
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-[#8B7EC7] focus:border-[#8B7EC7] focus:outline-none resize-none"
                                rows="4"
                            ></textarea>
                            <div class="mt-1 text-xs text-gray-400">
                                Ej: Cliente frecuente, entrega especial, etc.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Totales y Botones -->
                <div class="flex justify-between items-end">
                    <div>
                        <button class="bg-[#8B7EC7] text-white px-4 py-2 rounded-lg hover:bg-[#7A6DB4] transition-colors">
                            Agregar producto
                        </button>
                    </div>
                    <div class="space-y-2 min-w-[200px]">
                        <div class="flex justify-between gap-8">
                            <span class="text-gray-600">Subtotal</span>
                            <span id="subtotalDisplay" class="font-medium">$0.00</span>
                        </div>
                        <div id="discountRow" class="flex justify-between gap-8 text-red-600" style="display: none;">
                            <span>Descuento (<span id="discountPercentDisplay">0</span>%)</span>
                            <span id="discountAmountDisplay" class="font-medium">-$0.00</span>
                        </div>
                        <div id="taxRow" class="flex justify-between gap-8 text-blue-600" style="display: none;">
                            <span>IVA (<span id="taxPercentDisplay">0</span>%)</span>
                            <span id="taxAmountDisplay" class="font-medium">+$0.00</span>
                        </div>
                        <hr class="border-gray-200">
                        <div class="flex justify-between gap-8">
                            <span class="text-gray-800 font-semibold">Total</span>
                            <span id="totalDisplay" class="font-bold text-lg">$0.00</span>
                        </div>
                        <button class="w-full bg-[#8B7EC7] text-white px-6 py-2 rounded-lg hover:bg-[#7A6DB4] transition-colors">
                            Cobrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="/js/services/authService.js"></script>
    <script type="module" src="/js/utils/uiUtils.js"></script>
    <script type="module" src="/js/modules/dashboardHandler.js"></script>
    <script type="module" src="/js/services/salesService.js"></script>
    <script type="module" src="/js/services/customerService.js"></script>
    <script type="module" src="/js/utils/apiDiagnostic.js"></script>
    <script type="module" src="/js/utils/customerTesting.js"></script>
    <script type="module" src="/js/utils/salesTesting.js"></script>
    <script type="module" src="/js/utils/dailyCounterManager.js"></script>
    <script type="module" src="/js/testing/paymentMethodTest.js"></script>
    <script type="module">
      import { SalesHandler } from "/js/modules/salesHandler.js"
      import { CustomerHandler } from "/js/modules/customerHandler.js"
      import { ApiDiagnostic } from "/js/utils/apiDiagnostic.js"

      document.addEventListener("DOMContentLoaded", async () => {
        console.log("Inicializando sistema de ventas con gesti贸n de clientes...")
        
        // Inicializar salesHandler primero
        window.salesHandler = new SalesHandler()
        
        // Inicializar customerHandler con referencia a salesHandler
        window.customerHandler = new CustomerHandler(window.salesHandler)
        
        // Establecer referencia bidireccional
        window.salesHandler.setCustomerHandler(window.customerHandler)
        
        // Diagn贸stico de la API
        console.log(" Ejecutando diagn贸stico de la API...")
        window.apiDiagnostic = new ApiDiagnostic()
        
        // Ejecutar diagn贸stico despu茅s de un peque帽o delay
        setTimeout(async () => {
          await window.apiDiagnostic.runFullDiagnostic()
        }, 1000)
        
                // Test del contador de transacciones despu茅s de cargar
        setTimeout(() => {
          console.log(" Scripts de testing disponibles:")
          console.log("   === CONTADOR DE TRANSACCIONES ===")
          console.log("   testTransactionCounter() - Test b谩sico")
          console.log("   testWithFilters() - Test con filtros")
          console.log("   testDailyCounters() - Test de contadores diarios")
          console.log("   === GESTIN DE CLIENTES ===")
          console.log("   diagnoseCurrientCustomerIntegration() - Diagn贸stico completo")
          console.log("   testCustomerFunctionality() - Test de funcionalidades")
          console.log("   === DESCUENTOS E IVA ===")
          console.log("   testDiscountAndTaxControls() - Test de controles")
          console.log("   testCalculations() - Test de c谩lculos")
          console.log("   === MTODOS DE PAGO ===")
          console.log("   testPaymentMethods() - Test de controles de pago")
          console.log("   testPaymentMethodInSale() - Test en venta completa")
          console.log("   showPaymentMethodStatus() - Estado actual")
        }, 2000)
      })
    </script>
    <script type="module" src="/js/components/userMenuComponent.js"></script>
    <script type="module" src="/js/modules/userMenuHandler.js"></script>
    <script type="module" src="/js/components/sidebarComponent.js"></script>
    <script type="module" src="/js/modules/sidebarHandler.js"></script>
</body>
</html>